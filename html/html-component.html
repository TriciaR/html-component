<script>
// Base class for creating Web Components
window.HTMLComponent = class HTMLComponent extends HTMLElement {

	static get is() {
		return this.nodeName.toLowerCase()
	}

	// Required by the custom elements polyfill
	constructor(_) {
		return (_ = super(_)).init(), _;
	}

	// override on custom elements
	init() {
		this.render()
	}

	static create(props) {
		return new this().set(props)
	}

	// Shortcut for addEventListener with support for event delegation
	on(eventName, selector, callback) {

		this.addEventListener(eventName, e => {
			if (arguments.length == 2) {
				callback = selector
				handleEvent(e, this)
			} else if (e.target.matches(selector)) {
				handleEvent(e, this)
			}
		})

		function handleEvent(e, self) {
			if (self._before) self._before(e)
			callback(e)
			if (self._after) self._after(e)
		}

		return this
  }

	off(e) {
		this.removeEventListener(e)
	}

	// Sets a listener to run after all events subscribed with .on
	beforeEach(handler) {
		this._before = handler
		return this
	}

	// Sets a listener to run after all events subscribed with .on
	afterEach(handler) {
		this._after = handler
		return this
	}

	// Publish events to notify parents of internal changes
	publish(eventName, data) {
		this.dispatchEvent(new CustomEvent(eventName, {
			bubbles: true,
			detail: data
		}))
	}

	// Shortcut for getAttribute, with a basic type conversion
	get(name) {
		var value = this.getAttribute(name)
		if (value.match(/^(true|false|undefined)$/))
			value = value == 'true'
		else if (!isNaN(value))
			value = Number(value)
		return value
	}

	// Shortcut for setAttribute, automatically re-render the view
	set(data) {
		for(var name in data) {
			var value = data[name]
			this.setAttribute(name, value)
		}
		return this.render()
	}

	// Mounts a hash with all attributes
	get props() {
		var s = {}
		var props = this.attributes
		for(var i = props.length - 1; i >= 0; i--) {
			var prop = props[i].name
			s[prop] = this.get(prop)
		}
		return s
	}

	show() { this.classList.remove('hidden') }
	hide() { this.classList.add('hidden') }
	toggle(showOrHide) { this.classList.toggle('hidden', showOrHide) }

	// using compiled mustache templates by default
  template(data) {
		data.props = this.props
    var tmpl = window.templates[this.constructor.is]
    return tmpl.render(data)
  }

	// Render template with props and replaces inner html
	render(data) {
		// Optionally mark a section to not be replaced on re-renders
		var fixed = this.query('[fixed]')

		// Helper function for innerHTML, required by the custom elements polyfill
		innerHTML(this, this.template(data))

		if (fixed) {
			this.query('[fixed]').replaceWith(fixed)
		}

		return this
	}
}

// If using native custom elements, the innerHTML helper won't exist
if (!window.innerHTML) {
	window.innerHTML = function(elm, html) {
		elm.innerHTML  = html
	}
}
</script>
